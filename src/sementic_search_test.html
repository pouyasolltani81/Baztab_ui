<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Semantic Search Service</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">



       <!-- Navbar -->
<div class="bg-teal-50 shadow-md ">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between bg-teal-50">
  
      <!-- Back to Category Button (Left) -->
      <button type="button" id="BackToCategory" class="text-gray-700 font-semibold hover:text-gray-900 transition duration-200" onclick=" window.location.href = './category.html';">
        ← بازگشت
      </button>
    
      <!-- Menu Links (Center) -->
      <div class="hidden md:flex space-x-4 space-x-reverse gap-4">
        <a href="./mall.html" class="text-gray-600 hover:text-teal-800 transition duration-200">آمار پایگاه داده</a>
      </div>
    
      <!-- User and Breadcrumb Info (Right) -->
      
        <div class="flex gap-4 border-2 border-teal-600 rounded-md p-4 bg-teal-100 shadow-lg">
          <div class="flex gap-4 text-teal-800 font-semibold">
              نام کاربری: <span class="text-teal-900" id="Username">something</span>
          </div>
          <div class="flex-1 text-teal-800 font-semibold">
            <span class="cursor-pointer" onclick="window.location.href = './category.html'">دسته‌بندی : </span> <span class="text-teal-900">Products</span>
        </div>
      </div>
    </div>
    
      <!-- Auth Buttons (Right) -->
      <div id="AUTH_BUTTONS_MAIN" class="flex space-x-4 space-x-reverse hidden">
        <!-- <button id="loginBtn" class="bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 rounded-md px-4 py-2 transition duration-200">
          ورود
        </button>
        <button id="registerBtn" class="bg-teal-500 text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-opacity-50 rounded-md px-4 py-2 transition duration-200">
          ثبت نام
        </button> -->
      </div>
      
      <!-- Mobile Hamburger Button -->
      <div class="md:hidden flex items-center space-x-2 space-x-reverse">
        <!-- <button id="hamburgerMenuBtn" class="text-gray-600 hover:text-gray-800 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button> -->
      </div>
    </div>
  </div>
  
  <!-- Mobile Menu (Hidden by default, shown when hamburger is clicked) -->
  <div id="mobileMenu" class="md:hidden bg-white shadow-md hidden">
    <div class="px-6 py-4 space-y-4 ">
      <!-- <button id="findCategoryBtnMobile" class="text-gray-600 hover:text-gray-800 w-full text-center">محصولات</button> -->
      <!-- <button id="createCategoryBtnMobile" class="text-gray-600 hover:text-gray-800 w-full text-center">به روز رسانی</button> -->
      <a href="./mall.html"><button  class="text-gray-600 text-gray-600 hover:text-teal-800">آمار پایگاه داده</button></a>
  
      <div class="flex flex-col space-y-4 ">
        <!-- <button id="loginBtnMobile" class="bg-blue-500 text-white hover:bg-blue-600 rounded-md px-4 py-2 transition duration-200 w-full">
          ورود
        </button>
        <button id="registerBtnMobile" class="bg-teal-500 text-white hover:bg-teal-600 rounded-md px-4 py-2 transition duration-200 w-full">
          ثبت نام
        </button> -->
      </div>
    </div>
  </div>
  
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-8">
      <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold">Semantic Search Service</h1>
        <p class="mt-2 text-lg">
          Search similar content in the database using text, image, or audio.
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      <!-- Introduction -->
      <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-2">Test Our API Service</h2>
        <p class="text-gray-600">
          Enter a search query or upload an image/audio file to perform a semantic search in the database. You may optionally specify the number of top results.
        </p>
      </section>

      <!-- Form Section -->
      <section class="bg-white shadow rounded-lg p-6 mb-8">
        <form id="searchForm" class="space-y-4">
          <!-- Query Input -->
          <div>
            <label for="query" class="block text-sm font-medium text-gray-700">Query</label>
            <input
              type="text"
              name="query"
              id="query"
              placeholder="Enter your search query"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <!-- Topk Input -->
          <div>
            <label for="topk" class="block text-sm font-medium text-gray-700">Top K Results (optional)</label>
            <input
              type="number"
              name="topk"
              id="topk"
              placeholder="e.g. 50"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <!-- Image Upload -->
          <div>
            <label for="image" class="block text-sm font-medium text-gray-700">Image File (optional)</label>
            <input
              type="file"
              name="image"
              id="image"
              accept="image/*"
              class="mt-1 block w-full"
            />
          </div>
          <!-- Audio Upload -->
          <div>
            <label for="audio" class="block text-sm font-medium text-gray-700">Audio File (optional)</label>
            <input
              type="file"
              name="audio"
              id="audio"
              accept="audio/*"
              class="mt-1 block w-full"
            />
          </div>
          <p class="text-sm text-gray-500">
            Note: Provide only one type of input—either text, image, or audio.
          </p>
          <!-- Buttons -->
          <div class="flex space-x-4">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              Search
            </button>
            <button type="reset" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
              Reset
            </button>
          </div>
        </form>
      </section>

      <!-- Results Section -->
      <section id="resultsSection" class="hidden">
        <h2 class="text-2xl font-semibold mb-4">Search Results</h2>
        <div id="resultsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Product cards will be injected here -->
        </div>
      </section>

      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50">
        <div class="text-white text-xl">Loading...</div>
      </div>
    </main>

    <script src="./fetching.js"></script>
    <script src="./ui_logic_p.js"></script>

    

    <!-- JavaScript to handle form submission and display results -->
    <script>
      document.getElementById('searchForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Clear previous results
        document.getElementById('resultsContainer').innerHTML = '';
        document.getElementById('resultsSection').classList.add('hidden');

        // Show loading indicator
        document.getElementById('loadingIndicator').classList.remove('hidden');

        // Retrieve form values
        const query = document.getElementById('query').value;
        const topk = document.getElementById('topk').value;
        const imageFile = document.getElementById('image').files[0];
        const audioFile = document.getElementById('audio').files[0];
        console.log(query ,  topk , imageFile ,audioFile);
        

        // Ensure one (and only one) input type is provided
        let providedCount = 0;
        if (query.trim() !== '') providedCount++;
        if (imageFile) providedCount++;
        if (audioFile) providedCount++;
        if (providedCount === 0) {
          alert('Please provide at least one input: text, image, or audio.');
          document.getElementById('loadingIndicator').classList.add('hidden');
          return;
        }
        if (providedCount > 1) {
          alert('Please provide only one type of input: either text, image, or audio.');
          document.getElementById('loadingIndicator').classList.add('hidden');
          return;
        }

        // Create form data payload
        const formData = new FormData();
        formData.append('query', query);
        formData.append('topk', topk);
        if (imageFile) {
          formData.append('image', imageFile);
        } else {
          formData.append('image', '');
        }
        if (audioFile) {
          formData.append('audio', audioFile);
        } else {

          formData.append('audio', '');


        }

        console.log(formData , query ,topk );

        // const body_c = {
        //     'query' : query, 
        //     'topk' : 5
        // }
        

        try {


        const response = await connect_to_server('http://79.175.177.113:21800/AIAnalyze/agent_based_find_similar_content/' , 'POST' , user_token, 'multipart/form-data' , formData , 'sementic_search' )
          

          console.log(response);
          

          if (!response.ok) {
            throw new Error('Network response was not ok');
          }

          const result = await response.json();

          // Hide loading indicator
          document.getElementById('loadingIndicator').classList.add('hidden');

          if (result.return !== true) {
            alert('Error: ' + result.message);
            return;
          }

          const resultsContainer = document.getElementById('resultsContainer');
          result.data.forEach((item) => {
            // Create a card for each product
            const card = document.createElement('div');
            card.className = 'bg-white shadow rounded-lg overflow-hidden';

            // Add product image if available
            if (item.metadata && item.metadata.primary_image) {
              const img = document.createElement('img');
              img.src = item.metadata.primary_image;
              img.alt = item.metadata.name || 'Product Image';
              img.className = 'w-full h-48 object-cover';
              card.appendChild(img);
            }

            const cardBody = document.createElement('div');
            cardBody.className = 'p-4';

            // Product name
            const nameEl = document.createElement('h3');
            nameEl.className = 'text-lg font-bold mb-2';
            nameEl.textContent = item.metadata?.name || 'Unnamed Product';
            cardBody.appendChild(nameEl);

            // Category
            if (item.metadata?.category) {
              const categoryEl = document.createElement('p');
              categoryEl.className = 'text-sm text-gray-600';
              categoryEl.textContent = 'Category: ' + item.metadata.category;
              cardBody.appendChild(categoryEl);
            }

            // Price (if provided and numeric)
            if (item.metadata?.price && !isNaN(item.metadata.price)) {
              const priceEl = document.createElement('p');
              priceEl.className = 'text-sm text-green-600 font-semibold mt-2';
              priceEl.textContent = 'Price: ' + item.metadata.price;
              cardBody.appendChild(priceEl);
            }

            card.appendChild(cardBody);
            resultsContainer.appendChild(card);
          });

          if (result.data.length > 0) {
            document.getElementById('resultsSection').classList.remove('hidden');
          } else {
            alert('No results found.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
          document.getElementById('loadingIndicator').classList.add('hidden');
        }
      });
    </script>
  </body>
</html>
